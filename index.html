<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dark Sky Times Calendar</title>
    <link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/main.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/main.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/luxon@3.2.1/build/global/luxon.min.js"></script>
    <script src="astronomy.browser.js"></script>
    <style>
        #calendar {
            max-width: 900px;
            margin: 20px auto;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }

        .form-container {
            max-width: 900px;
            margin: 20px auto;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 5px;
            background-color: #f9f9f9;
        }

        .form-container input {
            margin: 5px;
            padding: 5px;
        }

        .form-container button {
            padding: 5px 10px;
        }
    </style>
</head>
<body>
    <div class="form-container">
        <label>Latitude: <input type="text" id="EditLatitude" placeholder="e.g., 40.7128"></label>
        <label>Longitude: <input type="text" id="EditLongitude" placeholder="e.g., -74.0060"></label>
        <label>Elevation (meters): <input type="text" id="EditElevation" placeholder="e.g., 10"></label><br>
        <label>Start Date: <input type="date" id="EditDateStart"></label>
        <label>End Date: <input type="date" id="EditDateEnd"></label>
        <button onclick="UpdateScreen()">Calculate</button>
    </div>
    <div id="calendar"></div>

    <script>
        const { DateTime } = luxon;

        // Validate if input is a valid number
        function IsValidNumber(value) {
            return !isNaN(value) && value.trim() !== '';
        }

        // Convert dark sky times into events for FullCalendar
        function DisplayDarkTimesInCalendar(darkTimes) {
            const calendarEl = document.getElementById('calendar');

            // Convert darkTimes object to FullCalendar-compatible events
            const events = [];
            for (const date in darkTimes) {
                darkTimes[date].forEach(time => {
                    events.push({
                        title: 'Dark Sky Time',
                        start: new Date(time.start).toISOString(),
                        end: new Date(time.end).toISOString(),
                        allDay: false
                    });
                });
            }

            // Initialize the FullCalendar instance
            const calendar = new FullCalendar.Calendar(calendarEl, {
                initialView: 'dayGridMonth',
                events: events,
                headerToolbar: {
                    start: 'prev,next today', // Navigation buttons
                    center: 'title',         // Calendar title
                    end: 'dayGridMonth,timeGridWeek,listWeek' // View options
                }
            });

            calendar.render();
        }

        // Update the screen based on user input
        function UpdateScreen() {
            const text_latitude = document.getElementById('EditLatitude').value;
            const text_longitude = document.getElementById('EditLongitude').value;
            const text_elevation = document.getElementById('EditElevation').value;
            const text_dateStart = document.getElementById('EditDateStart').value;
            const text_dateEnd = document.getElementById('EditDateEnd').value;

            if (!IsValidNumber(text_latitude) || !IsValidNumber(text_longitude) || !IsValidNumber(text_elevation)) {
                document.getElementById('calendar').innerHTML = '<p>Invalid input values. Please correct them.</p>';
            } else {
                const latitude = parseFloat(text_latitude);
                const longitude = parseFloat(text_longitude);
                const elevation = parseFloat(text_elevation);
                const zone = 'America/Denver'; // Adjust time zone as needed

                const dtStart = DateTime.fromISO(text_dateStart, { zone });
                const dtEnd = DateTime.fromISO(text_dateEnd, { zone });

                const observer = new Astronomy.Observer(latitude, longitude, elevation);
                const darkTimes = getTimes(dtStart, dtEnd, observer);

                // Display results in the calendar
                DisplayDarkTimesInCalendar(darkTimes);
            }
        }

        // Calculate dark sky times
        function getTimes(dtStart, dtEnd, observer) {
            let darkObj = {};

            while (dtStart <= dtEnd) {
                const twilightStart = Astronomy.SearchAltitude('Sun', observer, -1, dtStart.toJSDate(), 1, -18);
                const twilightEnd = Astronomy.SearchAltitude('Sun', observer, +1, dtStart.toJSDate(), 1, -18);
                
                const moonRise = Astronomy.SearchRiseSet('Moon', observer, +1, dtStart.toJSDate(), 1);
                const moonSet = Astronomy.SearchRiseSet('Moon', observer, -1, dtStart.toJSDate(), 1);

                let moonAltStartDay = calculateMoonAltitude(observer, dtStart.toJSDate());
                let moonAltEndDay = calculateMoonAltitude(observer, dtStart.plus({days: 1}).toJSDate());
                let moonAltEndTwilight = calculateMoonAltitude(observer, twilightEnd.date);
                let moonAltStartTwilight = calculateMoonAltitude(observer, twilightStart.date);

                const currentDate = dtStart.toISODate();
                if (!darkObj[currentDate]) {
                    darkObj[currentDate] = [];
                }

                if (moonAltStartDay <= 0 && moonAltEndTwilight <= 0) {
                    let dawnDarkTimes = {
                        start: dtStart.toJSDate(),
                        end: twilightEnd.date
                    };
                    darkObj[currentDate].push(dawnDarkTimes);
                } else if (moonSet && moonAltStartDay >= 0) {
                    if (moonSet.date.valueOf() < twilightEnd.date.valueOf()) {
                        let dawnDarkTimes = {
                            start: moonSet.date,
                            end: twilightEnd.date
                        };
                        darkObj[currentDate].push(dawnDarkTimes);
                    }
                } else if (moonRise && moonAltStartDay <= 0) {
                    if (moonRise.date.valueOf() < twilightEnd.date.valueOf()) {
                        let dawnDarkTimes = {
                            start: dtStart.toJSDate(),
                            end: moonRise.date,
                        };
                        darkObj[currentDate].push(dawnDarkTimes);
                    }
                }

                if (moonAltStartTwilight <= 0 && moonAltEndDay <= 0) {
                    let duskDarkTimes = {
                        start: twilightStart.date,
                        end: dtStart.plus({days: 1}).minus({milliseconds: 1}).toJSDate()
                    };
                    darkObj[currentDate].push(duskDarkTimes);
                } else if (moonSet && moonAltEndDay <= 0) {
                    if (moonSet.date.valueOf() > twilightStart.date.valueOf()) {
                        let duskDarkTimes = {
                            start: moonSet.date,
                            end: dtStart.plus({days: 1}).minus({milliseconds: 1}).toJSDate()
                        };
                        darkObj[currentDate].push(duskDarkTimes);
                    }
                } else if (moonRise && moonAltEndDay >= 0) {
                    if (moonRise.date.valueOf() > twilightStart.date.valueOf()) {
                        let duskDarkTimes = {
                            start: twilightStart.date,
                            end: moonRise.date
                        };
                        darkObj[currentDate].push(duskDarkTimes);
                    }
                }

                dtStart = dtStart.plus({days: 1});
            }
            return darkObj;
        }
    </script>
</body>
</html>
